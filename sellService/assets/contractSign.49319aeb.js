var y=Object.defineProperty;var c=Object.getOwnPropertySymbols;var x=Object.prototype.hasOwnProperty,T=Object.prototype.propertyIsEnumerable;var l=(t,s,a)=>s in t?y(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,h=(t,s)=>{for(var a in s||(s={}))x.call(s,a)&&l(t,a,s[a]);if(c)for(var a of c(s))T.call(s,a)&&l(t,a,s[a]);return t};import{_ as C,r as d,o as g,h as m,d as u,b as i,M as p,N as f,k as w,n as L,t as B,w as b,g as P,p as E,f as N,l as D,B as V,e as z}from"./index.40739931.js";import{N as A}from"./hh-nav.7bea9b7f.js";import{h as F}from"./html2canvas.esm.3d083717.js";import{d as I,u as v}from"./aliOSS.5489fc1a.js";import"./_commonjsHelpers.88e99c8f.js";const O={components:{NavBar:A},setup(){const t=()=>{history.back()},s=d(),{proxy:a}=P(),e=d("");return{onClickLeft:t,proxy:a,orderImgSrc:s,signImg:e}},data(){return{orderToken:"",orderId:"",gymId:"",isStartSign:!1,touchPressed:!1,ctx:null,strokeStyle:"#EE2F2F",lineWidth:2,lastX:null,lastY:null,canvas:null,allImgBase64:"",upImgTimer:null,upImgPathLs:[],uploadStatus:[0,0]}},mounted(){var{token:t,id:s,orderId:a}=h({},this.$route.query);this.orderToken=t,this.gymId=s,this.orderId=a,this.getGymSignOrderData(),this.$nextTick(()=>{let e=document.getElementById("myCanvas");this.canvas=e,this.ctx=e.getContext("2d");let o=window.innerWidth,r=window.innerHeight;e.width=o,e.height=r,this.Init()})},methods:{signClick(){this.isStartSign=!this.isStartSign,this.isStartSign||this.onExport()},getGymSignOrderData(){this.proxy.$api.getGymSignOrderOutside(this.orderId,this.orderToken).then(t=>{this.orderImgSrc=t.data.contract_img,t.data.state>=5&&(this.$toast("\u5F53\u524D\u5408\u540C\u5DF2\u7B7E\u7EA6"),setTimeout(()=>{this.$router.push({path:"/pay",query:{gymId:this.gymId,orderId:this.orderId,token:this.orderToken}})},1500))}).catch(t=>{t.code==422&&this.$toast("\u83B7\u53D6\u5408\u540C\u4FE1\u606F\u5931\u8D25\uFF0C\u8BF7\u8054\u7CFB\u9500\u552E\u4EBA\u5458")})},Init(){this.canvas.addEventListener("touchstart",t=>{if(t.targetTouches.length==1){t.preventDefault();var s=t.targetTouches[0];this.touchPressed=!0,this.draw(s.pageX-this.canvas.offsetLeft,s.pageY-this.canvas.offsetTop,!1)}},!1),this.canvas.addEventListener("touchmove",t=>{if(t.targetTouches.length==1){t.preventDefault();var s=t.targetTouches[0];this.touchPressed&&this.draw(s.pageX-this.canvas.offsetLeft,s.pageY-this.canvas.offsetTop,!0)}},!1),this.canvas.addEventListener("touchend",t=>{t.targetTouches.length==1&&(t.preventDefault(),this.touchPressed=!1)},!1)},draw(t,s,a){let e=this.ctx;a&&(e.beginPath(),e.strokeStyle=this.strokeStyle,e.lineWidth=this.lineWidth,e.lineJoin="round",e.moveTo(this.lastX,this.lastY),e.lineTo(t,s),e.closePath(),e.stroke()),this.lastX=t,this.lastY=s},sureClick(){if(this.signImg==""){this.$toast("\u8BF7\u7B7E\u5B57\u540E\u63D0\u4EA4");return}this.uploadAllImage();var t=0;this.upImgTimer=setInterval(()=>{t++;var s=!0;for(const e of this.uploadStatus)e==0&&(s=!1);if(s){var a={contractImg:"https://zkyk-gym.oss-cn-guangzhou.aliyuncs.com/"+this.upImgPathLs[0],contractSign:"https://zkyk-gym.oss-cn-guangzhou.aliyuncs.com/"+this.upImgPathLs[1]};this.proxy.$api.sendUserSignContract(this.orderId,this.orderToken,a).then(e=>{this.$toast("\u5408\u540C\u7B7E\u7F72\u6210\u529F"),setTimeout(()=>{this.$router.push({path:"/pay",query:{gymId:this.gymId,orderId:this.orderId,token:this.orderToken}})},1500)}),clearInterval(this.upImgTimer);return}t>=20&&(this.$toast("\u4E0A\u4F20\u7B7E\u7F72\u5408\u540C\u5931\u8D25,\u8BF7\u91CD\u8BD5"),clearInterval(this.upImgTimer))},500)},onExport(){var t=this.canvas.toDataURL("image/png");this.signImg=t;var s=this.canvas.width,a=this.canvas.height;this.ctx.clearRect(0,0,s,a),setTimeout(()=>{this.onExportAll()},1e3)},onExportAll(){F(this.$refs.allShowV,{useCORS:!0,logging:!0}).then(t=>{this.allImgBase64=t.toDataURL("image/jpeg")})},uploadAllImage(){const t="exercise/gymSell/gymImgs/contractImg/"+this.orderId.toString()+".jpg";this.upImgPathLs[0]=t;var a=I(this.allImgBase64,t);v(t,a).then(e=>{console.log("\u4E0A\u4F20\u5168\u90E8\u6210\u529F"),this.uploadStatus[0]=1}).catch(e=>{console.log("\u4E0A\u4F20\u5168\u90E8\u5931\u8D25",e),this.uploadStatus[0]=0});const s="exercise/gymSell/gymImgs/contractSignImg/"+this.orderId.toString()+".jpg";this.upImgPathLs[1]=s;var a=I(this.signImg,s);v(t,a).then(e=>{console.log("\u4E0A\u4F20\u7B7E\u5B57\u6210\u529F"),this.uploadStatus[1]=1}).catch(e=>{console.log("\u4E0A\u4F20\u7B7E\u5B57\u5931\u8D25",e),this.uploadStatus[1]=0})}}},n=t=>(E("data-v-0457c488"),t=t(),N(),t),R={class:"mainPage van-safe-area-top"},U={class:"container"},W={class:"signV"},X=n(()=>i("text",{class:"mt20 norText",style:{"--c":"#fff"}},"\u8BF7\u4ED4\u7EC6\u9605\u8BFB\u5408\u540C\u5185\u5BB9\uFF0C\u786E\u8BA4\u65E0\u8BEF\u540E\u7B7E\u5B57",-1)),Y=n(()=>i("canvas",{id:"myCanvas"},null,-1)),$=[X,Y],j={class:"orderLookImgV",ref:"allShowV"},q=["src"],G=["src"],H={class:"bottom"},Z=n(()=>i("text",{class:"mt20 norText bottomTitle"},"\u8BF7\u4ED4\u7EC6\u9605\u8BFB\u5408\u540C\u5185\u5BB9\uFF0C\u786E\u8BA4\u65E0\u8BEF\u540E\u7B7E\u5B57",-1)),J={class:"oneCenter mtCustom",style:{"--z":"12px"}},M=z("\u786E\u8BA4");function K(t,s,a,e,o,r){const _=D("nav-bar"),S=V;return g(),m("div",R,[u(_,{text:"\u7535\u5B50\u5408\u540C",onBlackclick:e.onClickLeft,isblack:!0,issearch:!1},null,8,["onBlackclick"]),i("div",U,[p(i("div",W,$,512),[[f,o.isStartSign]]),p(i("div",j,[i("img",{src:e.orderImgSrc,class:"orderImg"},null,8,q),e.signImg!=""?(g(),m("img",{key:0,src:e.signImg,class:"signImg"},null,8,G)):w("",!0)],512),[[f,!o.isStartSign]]),i("div",H,[Z,i("div",{class:"markV",onClick:s[0]||(s[0]=(...k)=>r.signClick&&r.signClick(...k))},[i("text",{class:"regText",style:L(["--c: rgb(102, 102, 102)",o.isStartSign?"--fZ:24px;":"--fZ:16px;"])},B(o.isStartSign?"\u70B9\u51FB\u7ED3\u675F\u7B7E\u540D":"\u70B9\u51FB\u5F00\u59CB\u7B7E\u540D"),5)]),i("div",J,[u(S,{onClick:r.sureClick,class:"submitBtn"},{default:b(()=>[M]),_:1},8,["onClick"])])])])])}var ot=C(O,[["render",K],["__scopeId","data-v-0457c488"]]);export{ot as default};
