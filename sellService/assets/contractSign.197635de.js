var x=Object.defineProperty;var c=Object.getOwnPropertySymbols;var T=Object.prototype.hasOwnProperty,C=Object.prototype.propertyIsEnumerable;var l=(t,s,a)=>s in t?x(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,h=(t,s)=>{for(var a in s||(s={}))T.call(s,a)&&l(t,a,s[a]);if(c)for(var a of c(s))C.call(s,a)&&l(t,a,s[a]);return t};import{N as w}from"./hh-nav.65effb33.js";import{_ as L,h as d,o as g,i as m,d as u,b as i,v as p,x as f,k as b,n as P,t as B,w as E,g as D,p as N,f as V,r as I,e as z}from"./index.13643ac5.js";import{h as A}from"./html2canvas.esm.3d083717.js";import{d as v,u as _}from"./aliOSS.727054af.js";import"./_commonjsHelpers.88e99c8f.js";const F={components:{NavBar:w},setup(){const t=()=>{history.back()},s=d(),{proxy:a}=D(),e=d("");return{onClickLeft:t,proxy:a,orderImgSrc:s,signImg:e}},data(){return{orderToken:"",orderId:"",gymId:"",isStartSign:!1,touchPressed:!1,ctx:null,strokeStyle:"#EE2F2F",lineWidth:2,lastX:null,lastY:null,canvas:null,allImgBase64:"",upImgTimer:null,upImgPathLs:[],uploadStatus:[0,0]}},mounted(){var{token:t,id:s,orderId:a}=h({},this.$route.query);this.orderToken=t,this.gymId=s,this.orderId=a,this.getGymSignOrderData(),this.$nextTick(()=>{let e=document.getElementById("myCanvas");this.canvas=e,this.ctx=e.getContext("2d");let o=window.innerWidth,r=window.innerHeight;e.width=o,e.height=r,this.Init()})},methods:{signClick(){this.isStartSign=!this.isStartSign,this.isStartSign||this.onExport()},getGymSignOrderData(){this.proxy.$api.getGymSignOrderOutside(this.orderId,this.orderToken).then(t=>{this.orderImgSrc=t.data.contract_img,t.data.state>=5&&(this.$toast("\u5F53\u524D\u5408\u540C\u5DF2\u7B7E\u7EA6"),setTimeout(()=>{this.$router.push({path:"/pay",query:{gymId:this.gymId,orderId:this.orderId,token:this.orderToken}})},1500))}).catch(t=>{t.code==422&&this.$toast("\u83B7\u53D6\u5408\u540C\u4FE1\u606F\u5931\u8D25\uFF0C\u8BF7\u8054\u7CFB\u9500\u552E\u4EBA\u5458")})},Init(){this.canvas.addEventListener("touchstart",t=>{if(t.targetTouches.length==1){t.preventDefault();var s=t.targetTouches[0];this.touchPressed=!0,this.draw(s.pageX-this.canvas.offsetLeft,s.pageY-this.canvas.offsetTop,!1)}},!1),this.canvas.addEventListener("touchmove",t=>{if(t.targetTouches.length==1){t.preventDefault();var s=t.targetTouches[0];this.touchPressed&&this.draw(s.pageX-this.canvas.offsetLeft,s.pageY-this.canvas.offsetTop,!0)}},!1),this.canvas.addEventListener("touchend",t=>{t.targetTouches.length==1&&(t.preventDefault(),this.touchPressed=!1)},!1)},draw(t,s,a){let e=this.ctx;a&&(e.beginPath(),e.strokeStyle=this.strokeStyle,e.lineWidth=this.lineWidth,e.lineJoin="round",e.moveTo(this.lastX,this.lastY),e.lineTo(t,s),e.closePath(),e.stroke()),this.lastX=t,this.lastY=s},sureClick(){if(this.signImg==""){this.$toast("\u8BF7\u7B7E\u5B57\u540E\u63D0\u4EA4");return}this.uploadAllImage();var t=0;this.upImgTimer=setInterval(()=>{t++;var s=!0;for(const e of this.uploadStatus)e==0&&(s=!1);if(s){var a={contractImg:"https://zkyk-gym.oss-cn-guangzhou.aliyuncs.com/"+this.upImgPathLs[0],contractSign:"https://zkyk-gym.oss-cn-guangzhou.aliyuncs.com/"+this.upImgPathLs[1]};this.proxy.$api.sendUserSignContract(this.orderId,this.orderToken,a).then(e=>{this.$toast("\u5408\u540C\u7B7E\u7F72\u6210\u529F"),setTimeout(()=>{this.$router.push({path:"/pay",query:{gymId:this.gymId,orderId:this.orderId,token:this.orderToken}})},1500)}),clearInterval(this.upImgTimer);return}t>=20&&(this.$toast("\u4E0A\u4F20\u7B7E\u7F72\u5408\u540C\u5931\u8D25,\u8BF7\u91CD\u8BD5"),clearInterval(this.upImgTimer))},500)},onExport(){var t=this.canvas.toDataURL("image/png");this.signImg=t;var s=this.canvas.width,a=this.canvas.height;this.ctx.clearRect(0,0,s,a),setTimeout(()=>{this.onExportAll()},1e3)},onExportAll(){A(this.$refs.allShowV,{useCORS:!0,logging:!0}).then(t=>{this.allImgBase64=t.toDataURL("image/jpeg")})},uploadAllImage(){const t="exercise/gymSell/gymImgs/contractImg/"+this.orderId.toString()+".jpg";this.upImgPathLs[0]=t;var a=v(this.allImgBase64,t);_(t,a).then(e=>{console.log("\u4E0A\u4F20\u5168\u90E8\u6210\u529F"),this.uploadStatus[0]=1}).catch(e=>{console.log("\u4E0A\u4F20\u5168\u90E8\u5931\u8D25",e),this.uploadStatus[0]=0});const s="exercise/gymSell/gymImgs/contractSignImg/"+this.orderId.toString()+".jpg";this.upImgPathLs[1]=s;var a=v(this.signImg,s);_(t,a).then(e=>{console.log("\u4E0A\u4F20\u7B7E\u5B57\u6210\u529F"),this.uploadStatus[1]=1}).catch(e=>{console.log("\u4E0A\u4F20\u7B7E\u5B57\u5931\u8D25",e),this.uploadStatus[1]=0})}}},n=t=>(N("data-v-0457c488"),t=t(),V(),t),O={class:"mainPage van-safe-area-top"},R={class:"container"},U={class:"signV"},W=n(()=>i("text",{class:"mt20 norText",style:{"--c":"#fff"}},"\u8BF7\u4ED4\u7EC6\u9605\u8BFB\u5408\u540C\u5185\u5BB9\uFF0C\u786E\u8BA4\u65E0\u8BEF\u540E\u7B7E\u5B57",-1)),X=n(()=>i("canvas",{id:"myCanvas"},null,-1)),Y=[W,X],$={class:"orderLookImgV",ref:"allShowV"},j=["src"],q=["src"],G={class:"bottom"},H=n(()=>i("text",{class:"mt20 norText bottomTitle"},"\u8BF7\u4ED4\u7EC6\u9605\u8BFB\u5408\u540C\u5185\u5BB9\uFF0C\u786E\u8BA4\u65E0\u8BEF\u540E\u7B7E\u5B57",-1)),Z={class:"oneCenter mtCustom",style:{"--z":"12px"}},J=z("\u786E\u8BA4");function K(t,s,a,e,o,r){const S=I("nav-bar"),k=I("van-button");return g(),m("div",O,[u(S,{text:"\u7535\u5B50\u5408\u540C",onBlackclick:e.onClickLeft,isblack:!0,issearch:!1},null,8,["onBlackclick"]),i("div",R,[p(i("div",U,Y,512),[[f,o.isStartSign]]),p(i("div",$,[i("img",{src:e.orderImgSrc,class:"orderImg"},null,8,j),e.signImg!=""?(g(),m("img",{key:0,src:e.signImg,class:"signImg"},null,8,q)):b("",!0)],512),[[f,!o.isStartSign]]),i("div",G,[H,i("div",{class:"markV",onClick:s[0]||(s[0]=(...y)=>r.signClick&&r.signClick(...y))},[i("text",{class:"regText",style:P(["--c: rgb(102, 102, 102)",o.isStartSign?"--fZ:24px;":"--fZ:16px;"])},B(o.isStartSign?"\u70B9\u51FB\u7ED3\u675F\u7B7E\u540D":"\u70B9\u51FB\u5F00\u59CB\u7B7E\u540D"),5)]),i("div",Z,[u(k,{onClick:r.sureClick,class:"submitBtn"},{default:E(()=>[J]),_:1},8,["onClick"])])])])])}var it=L(F,[["render",K],["__scopeId","data-v-0457c488"]]);export{it as default};
